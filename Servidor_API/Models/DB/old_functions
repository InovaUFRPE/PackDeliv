def saveAdress(json_adress):

    Session = getSession()
    session=Session()
    adress = Adress()
    adress.street=json_adress[ADRESS_STREET]
    adress.number=json_adress[ADRESS_NUMBER]
    adress.complement=json_adress[ADRESS_COMPLEMENT]
    adress.district=json_adress[ADRESS_DISTRICT]
    adress.postal_code=json_adress[ADRESS_POSTAL_CODE]
    adress.city=json_adress[ADRESS_CITY]
    adress.state=json_adress[ADRESS_STATE]
    adress.country=json_adress[ADRESS_COUNTRY]
    session.add(adress)
    session.commit()
    session.refresh(adress)
    id=adress.id
    session.close()
    return id

def deleteAdress(id):
    Session = getSession()
    session=Session()
    session.query(Adress).filter(Adress.id == id).\
    delete()
    session.commit()
    session.close()

def getAdress(id):
    Session = getSession()
    session=Session()
    response=session.query(Adress).filter(Adress.id == id).all()
    if len(response)==1:
        r=response[0]
        adress={ADRESS_ID : r.id, ADRESS_STREET : r.street,ADRESS_NUMBER : r.number, ADRESS_COMPLEMENT : r.complement, ADRESS_DISTRICT : r.district, ADRESS_POSTAL_CODE :r.postal_code,ADRESS_CITY :  r.city, ADRESS_STATE : r.state, ADRESS_COUNTRY : r.country}
        return {"response" : adress }
    else:
        return {"response" : "invalid adress"}

def editAdress(json_adress):
    Session = getSession()
    session=Session()
    id=json_adress[ADRESS_ID]
    response=session.query(Adress).filter(Adress.id == id).all()
    
    if len(response)==1:
        adress=response[0]
        adress.street=json_adress[ADRESS_STREET]
        adress.number=json_adress[ADRESS_NUMBER]
        adress.complement=json_adress[ADRESS_COMPLEMENT]
        adress.district=json_adress[ADRESS_DISTRICT]
        adress.postal_code=json_adress[ADRESS_POSTAL_CODE]
        adress.city=json_adress[ADRESS_CITY]
        adress.state=json_adress[ADRESS_STATE]
        adress.country=json_adress[ADRESS_COUNTRY]
        session.add(adress)
        session.commit()
        session.refresh(adress)
        session.close()
        return {"response" : adress }
    else:
        return {"response" : "invalid adress"}

def saveVehicle(json_vehicle):
    Session= getSession()
    session=Session()
    vehicle=Vehicle()
    vehicle.licence_plate=json_vehicle[VEHICLE_LICENSE_PLATE]
    vehicle.model=json_vehicle[VEHICLE_MODEL]
    vehicle.year=json_vehicle[VEHICLE_YEAR]
    #vehicle.ready=json_vehicle['']
    #vehicle.color=json_vehicle['']
    session.add(vehicle)
    session.commit()
    session.refresh(vehicle)
    id=vehicle.id
    session.close()
    return id



def saveDeliveryman(json_deliveryman):
    id_adress=saveAdress(json_deliveryman[ADRESS])
    id_vehicle=saveVehicle(json_deliveryman[VEHICLE])
    Session=getSession()
    session=Session()
    deliveryman=Deliveryman()

    deliveryman.dui=json_deliveryman[DELIVERYMAN_DUI]
    deliveryman.Id_veiculo=id_vehicle
    deliveryman.id_adress=id_adress
    deliveryman.name_company=json_deliveryman[COMPANY_NAME]
    deliveryman.name_deliveryman=json_deliveryman[DELIVERYMAN_NAME]
    deliveryman.password=json_deliveryman[COMPANY_PASSWORD]
    deliveryman.login=json_deliveryman[COMPANY_LOGIN]
    deliveryman.email=json_deliveryman[COMPANY_EMAIL]
    deliveryman.uci=json_deliveryman[COMPANY_UCI]

    session.add(deliveryman)
    response = False
    session.commit()
    session.refresh(deliveryman)
    response = deliveryman.id
    #deleteAdress(id_adress)

    session.close()
    return response

def savePackage(json_package):
    print(json_package)
    Session=getSession()
    session=Session()
    package=Package()

    package.width=json_package[PACKAGE_WIDTH]
    package.height=json_package[PACKAGE_HEIGHT]
    package.length=json_package[PACKAGE_LENGTH]
    package.weight=json_package[PACKAGE_WEIGHT]
    package.local_destiny=json_package[PACKAGE_LOCAL_DESTINY]
    package.local_start=json_package[PACKAGE_LOCAL_START]
    package.id_adress_start=json_package[PACKAGE_ID_START_ADRESS]
    
    #package.id_adress_destiny=json_package[PACKAGE_ID_ADRESS]
    #package.static_location=json_package[PACKAGE_CURRENT_STATIC_LOCATION]

    session.add(package)
    response=False
    
    session.commit()
    session.refresh(package)
    response = package.id    
    session.close()
    return response

def getPackages(id):
    Session=getSession()
    session=Session()
    response= session.query(Package).filter(Package.id_adress_start==id).all()
    listPackage=[{PACKAGE_ID : p.id,PACKAGE_WIDTH:p.width,PACKAGE_HEIGHT:p.height,PACKAGE_LENGTH:p.length,PACKAGE_WEIGHT:p.weight,PACKAGE_RECEIVED:p.received,PACKAGE_LOCAL_DESTINY: getAdress(p.id_adress_destiny) ,PACKAGE_LOCAL_START:getAdress(p.id_adress_destiny)} for p in response]
    return listPackage



  
def saveCompany(json_company):
    id_adress=saveAdress(json_company[ADRESS])
    Session=getSession()
    session=Session()
    company=Company()
    company.id_adress=id_adress
    company.name_company=json_company[COMPANY_NAME]
    company.password=json_company[COMPANY_PASSWORD]
    company.login=json_company[COMPANY_LOGIN]
    company.email=json_company[COMPANY_EMAIL]
    company.uci=json_company[COMPANY_UCI]
    session.add(company)
    response = False
    try:
        session.commit()
        session.refresh(company)
        response = company.id
    except:
        deleteAdress(id_adress)

    session.close()
    return response

def getCompany(json_company):
    login=json_company['login']
    senha=json_company['senha']
    Session=getSession()
    session=Session()
    response= session.query(Company).filter(Company.login == login , Company.password==senha).all()
    if len(response)==1:
        c=response[0]
        adress=getAdress(c.id_adress)["response"]
        #dic= company.__dict__
        #dicCompany={key : value for key, value in dic.items() if key != '_sa_instance_state' }
        dicCompany={COMPANY_ID :c.id , ADRESS : adress, COMPANY_TYPE : c.type, COMPANY_NAME: c.name_company,COMPANY_LOGIN: c.login,COMPANY_EMAIL:c.email,COMPANY_UCI:c.uci , COMPANY_TYPE:c.type}
        response= dicCompany
    else:
        response=False
    return response

def editCompany(json_company):
    Session=getSession()
    session=Session()
    id=json_company[COMPANY_ID]
    response= session.query(Company).filter(Company.id == id).all()
    company=response[0]
    json_adress=json_company[ADRESS]
    editAdress(json_adress)
    company.email=json_company[COMPANY_EMAIL]

    session.add(company)
    session.commit()
    session.close()
    return True